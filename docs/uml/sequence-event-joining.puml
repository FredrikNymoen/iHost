@startuml Event Joining Flow
!theme plain

title Event Joining with Payment (via Share Code)

actor User
participant "EventsScreen" as UI
participant "EventViewModel" as VM
participant "StripeViewModel" as StripeVM
participant "EventRepository" as EventRepo
participant "EventUserRepository" as EventUserRepo
participant "StripeRepository" as StripeRepo
participant "EventApi" as EventAPI
participant "EventUserApi" as EventUserAPI
participant "StripeApi" as StripeAPI
participant "Backend\nEventController" as EventCtrl
participant "Backend\nEventUserController" as EventUserCtrl
participant "Backend\nStripeController" as StripeCtrl
participant "EventService" as EventSvc
participant "EventUserService" as EventUserSvc
participant "PaymentService" as PaymentSvc
participant "Stripe" as StripeExt
participant "Firestore" as DB

== Find Event by Share Code ==

User -> UI: Enter share code\n(e.g., "IH-AB3X9")
activate UI

UI -> VM: getEventByCode("IH-AB3X9")
activate VM

VM -> EventRepo: getEventByCode("IH-AB3X9")
activate EventRepo

EventRepo -> EventAPI: getEventByCode("IH-AB3X9")
activate EventAPI

EventAPI -> EventCtrl: GET /api/events/by-code/IH-AB3X9
activate EventCtrl

EventCtrl -> EventSvc: findEventByShareCode(code, userId)
activate EventSvc

EventSvc -> DB: collection("events")\n.whereEqualTo("shareCode", code)\n.get()
activate DB
DB --> EventSvc: QuerySnapshot (event)
deactivate DB

EventSvc -> DB: collection("event_users")\n.whereEqualTo("eventId", eventId)\n.whereEqualTo("userId", userId)\n.get()
activate DB

alt User Already Associated
  DB --> EventSvc: Existing EventUser document
  note right of EventSvc
    User has PENDING, ACCEPTED,
    or DECLINED status
  end note
else User Not Associated Yet
  DB --> EventSvc: Empty result
  EventSvc -> DB: collection("event_users").add({\n  eventId: eventId,\n  userId: userId,\n  status: PENDING,\n  role: ATTENDEE,\n  invitedAt: now\n})
  activate DB
  DB --> EventSvc: DocumentReference
  deactivate DB
  note right of EventSvc
    PENDING status created
    User can now accept/decline
  end note
end
deactivate DB

EventSvc --> EventCtrl: EventWithMetadata\n(includes userStatus)
deactivate EventSvc

EventCtrl --> EventAPI: EventWithMetadataResponse
deactivate EventCtrl

EventAPI --> EventRepo: EventWithMetadataResponse
deactivate EventAPI

EventRepo --> VM: Result.Success(EventWithMetadata)
deactivate EventRepo

VM -> VM: Update uiState\n(selectedEvent)

VM --> UI: Event found
deactivate VM

UI -> UI: Show event details with\n"Accept Invitation" button
deactivate UI

== Accept Invitation (Free Event) ==

alt Event is Free (event.free == true)

  User -> UI: Click "Accept Invitation"
  activate UI

  UI -> VM: acceptInvitation(eventUserId)
  activate VM

  VM -> EventUserRepo: acceptInvitation(eventUserId)
  activate EventUserRepo

  EventUserRepo -> EventUserAPI: acceptInvitation(eventUserId)
  activate EventUserAPI

  EventUserAPI -> EventUserCtrl: POST /api/event-users/{eventUserId}/accept
  activate EventUserCtrl

  EventUserCtrl -> EventUserSvc: acceptInvitation(eventUserId, userId)
  activate EventUserSvc

  EventUserSvc -> DB: collection("event_users")\n.document(eventUserId)\n.update({\n  status: ACCEPTED,\n  respondedAt: now\n})
  activate DB
  DB --> EventUserSvc: Success
  deactivate DB

  EventUserSvc --> EventUserCtrl: EventUser
  deactivate EventUserSvc

  EventUserCtrl --> EventUserAPI: EventUserResponse
  deactivate EventUserCtrl

  EventUserAPI --> EventUserRepo: EventUserResponse
  deactivate EventUserAPI

  EventUserRepo --> VM: Result.Success(EventUser)
  deactivate EventUserRepo

  VM -> VM: Update event userStatus to ACCEPTED

  VM --> UI: Invitation accepted
  deactivate VM

  UI -> UI: Show "You're attending!" message
  deactivate UI

== Accept Invitation (Paid Event) ==

else Event Requires Payment (event.free == false)

  User -> UI: Click "Accept & Pay"
  activate UI

  UI -> StripeVM: initiatePayment(event.price, eventId)
  activate StripeVM

  StripeVM -> StripeRepo: createPaymentIntent(amount, eventId)
  activate StripeRepo

  StripeRepo -> StripeAPI: createPaymentIntent(PaymentIntentRequest)
  activate StripeAPI

  StripeAPI -> StripeCtrl: POST /api/stripe/payment-intent\nBody: {amount, eventId, userId}
  activate StripeCtrl

  StripeCtrl -> PaymentSvc: createPaymentIntent(amount, eventId, userId)
  activate PaymentSvc

  PaymentSvc -> StripeExt: Create Customer
  activate StripeExt
  StripeExt --> PaymentSvc: Customer ID
  deactivate StripeExt

  PaymentSvc -> StripeExt: Create Ephemeral Key\n(for customer)
  activate StripeExt
  StripeExt --> PaymentSvc: Ephemeral Key
  deactivate StripeExt

  PaymentSvc -> StripeExt: Create Payment Intent\n(amount in Ã¸re, currency: NOK)
  activate StripeExt
  StripeExt --> PaymentSvc: Payment Intent ID & Client Secret
  deactivate StripeExt

  PaymentSvc --> StripeCtrl: PaymentIntentResult\n{clientSecret, ephemeralKey, customer, publishableKey}
  deactivate PaymentSvc

  StripeCtrl --> StripeAPI: PaymentIntentResponse
  deactivate StripeCtrl

  StripeAPI --> StripeRepo: PaymentIntentResponse
  deactivate StripeAPI

  StripeRepo --> StripeVM: Result.Success(paymentData)
  deactivate StripeRepo

  StripeVM -> StripeVM: Update uiState\n(show payment sheet)

  StripeVM --> UI: Payment sheet ready
  deactivate StripeVM

  UI -> "Stripe Payment\nSheet": Show payment UI
  activate "Stripe Payment\nSheet"

  User -> "Stripe Payment\nSheet": Enter payment details

  "Stripe Payment\nSheet" -> StripeExt: Confirm payment
  activate StripeExt

  StripeExt -> StripeCtrl: Webhook: payment_intent.succeeded\nPOST /api/stripe/webhook
  activate StripeCtrl

  StripeCtrl -> PaymentSvc: handleWebhook(payload, signature)
  activate PaymentSvc

  PaymentSvc -> PaymentSvc: Verify webhook signature\nExtract event data

  alt Payment Succeeded
    PaymentSvc -> DB: Update payment record\n(mark as completed)
    activate DB
    DB --> PaymentSvc: Success
    deactivate DB

    note right of PaymentSvc
      Could also auto-accept
      invitation here if needed
    end note

    PaymentSvc --> StripeCtrl: Success
  else Payment Failed
    PaymentSvc --> StripeCtrl: Log error
  end

  deactivate PaymentSvc

  StripeCtrl --> StripeExt: 200 OK
  deactivate StripeCtrl

  StripeExt --> "Stripe Payment\nSheet": Payment confirmed
  deactivate StripeExt

  "Stripe Payment\nSheet" --> UI: Payment successful
  deactivate "Stripe Payment\nSheet"

  UI -> VM: acceptInvitation(eventUserId)
  activate VM

  note right of VM
    After payment succeeds,
    accept the invitation
  end note

  VM -> EventUserRepo: acceptInvitation(eventUserId)
  activate EventUserRepo

  EventUserRepo -> EventUserAPI: acceptInvitation(eventUserId)
  activate EventUserAPI

  EventUserAPI -> EventUserCtrl: POST /api/event-users/{eventUserId}/accept
  activate EventUserCtrl

  EventUserCtrl -> EventUserSvc: acceptInvitation(eventUserId, userId)
  activate EventUserSvc

  EventUserSvc -> DB: collection("event_users")\n.document(eventUserId)\n.update({status: ACCEPTED, respondedAt: now})
  activate DB
  DB --> EventUserSvc: Success
  deactivate DB

  EventUserSvc --> EventUserCtrl: EventUser
  deactivate EventUserSvc

  EventUserCtrl --> EventUserAPI: EventUserResponse
  deactivate EventUserCtrl

  EventUserAPI --> EventUserRepo: EventUserResponse
  deactivate EventUserAPI

  EventUserRepo --> VM: Result.Success(EventUser)
  deactivate EventUserRepo

  VM -> VM: Update userStatus to ACCEPTED

  VM --> UI: You're attending!
  deactivate VM

  UI -> UI: Show success message\n"Payment successful & you're attending!"
  deactivate UI

end

== Decline Invitation ==

User -> UI: Click "Decline"
activate UI

UI -> VM: declineInvitation(eventUserId)
activate VM

VM -> EventUserRepo: declineInvitation(eventUserId)
activate EventUserRepo

EventUserRepo -> EventUserAPI: declineInvitation(eventUserId)
activate EventUserAPI

EventUserAPI -> EventUserCtrl: POST /api/event-users/{eventUserId}/decline
activate EventUserCtrl

EventUserCtrl -> EventUserSvc: declineInvitation(eventUserId, userId)
activate EventUserSvc

EventUserSvc -> DB: collection("event_users")\n.document(eventUserId)\n.update({status: DECLINED, respondedAt: now})
activate DB
DB --> EventUserSvc: Success
deactivate DB

EventUserSvc --> EventUserCtrl: EventUser
deactivate EventUserSvc

EventUserCtrl --> EventUserAPI: EventUserResponse
deactivate EventUserCtrl

EventUserAPI --> EventUserRepo: EventUserResponse
deactivate EventUserAPI

EventUserRepo --> VM: Result.Success(EventUser)
deactivate EventUserRepo

VM -> VM: Update userStatus to DECLINED

VM --> UI: Invitation declined
deactivate VM

UI -> UI: Show "Invitation declined" message
deactivate UI

@enduml
