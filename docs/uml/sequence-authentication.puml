@startuml Authentication Flow
!theme plain

title User Registration and Login Flow

actor User
participant "LoginScreen" as UI
participant "AuthViewModel" as VM
participant "AuthRepository" as Repo
participant "FirebaseAuth\n(SDK)" as FireAuth
participant "UserApi\n(Retrofit)" as API
participant "FirebaseAuthInterceptor" as Interceptor
participant "Backend\nUserController" as Backend
participant "FirebaseTokenFilter" as Filter
participant "FirebaseAuth\n(Admin SDK)" as FireAdmin
participant "UserService" as Service
participant "Firestore" as DB

== User Registration ==

User -> UI: Enter registration details\n(email, password, name, username)
UI -> VM: signUp()
activate VM

VM -> Repo: registerUser(email, password, userData)
activate Repo

Repo -> FireAuth: createUserWithEmailAndPassword(email, password)
activate FireAuth
FireAuth --> Repo: FirebaseUser
deactivate FireAuth

Repo -> FireAuth: updateProfile(displayName, photoURL)
activate FireAuth
FireAuth --> Repo: Success
deactivate FireAuth

Repo -> FireAuth: getIdToken(forceRefresh = false)
activate FireAuth
FireAuth --> Repo: JWT Token
deactivate FireAuth

note right of Repo
  Token stored in Firebase SDK
  Will be used by interceptor
end note

Repo -> API: registerUser(CreateUserRequest)
activate API

API -> Interceptor: intercept(chain)
activate Interceptor

Interceptor -> FireAuth: currentUser?.getIdToken(false)
activate FireAuth
FireAuth --> Interceptor: JWT Token
deactivate FireAuth

Interceptor -> Backend: POST /api/users/register\nAuthorization: Bearer <token>
deactivate Interceptor
activate Backend

Backend -> Filter: doFilterInternal()
activate Filter

Filter -> FireAdmin: verifyIdToken(token)
activate FireAdmin
FireAdmin --> Filter: FirebaseToken (uid, email, etc.)
deactivate FireAdmin

Filter -> Filter: Set SecurityContext\nprincipal = uid
Filter --> Backend: Continue chain
deactivate Filter

Backend -> Service: createUser(user)
activate Service

Service -> DB: collection("users").document(uid).set(userData)
activate DB
DB --> Service: DocumentReference
deactivate DB

Service --> Backend: User
deactivate Service

Backend --> API: UserResponse
deactivate Backend

API --> Repo: UserResponse
deactivate API

Repo -> Repo: Map to User domain model

Repo --> VM: Result.Success(User)
deactivate Repo

VM -> VM: Update uiState\n(currentUser, isLoggedIn=true)

VM --> UI: Registration Success
deactivate VM

UI -> UI: Navigate to EventsScreen

== User Login ==

User -> UI: Enter email and password
UI -> VM: signIn(email, password)
activate VM

VM -> Repo: signIn(email, password)
activate Repo

Repo -> FireAuth: signInWithEmailAndPassword(email, password)
activate FireAuth
FireAuth --> Repo: AuthResult (FirebaseUser)
deactivate FireAuth

note right of Repo
  Firebase SDK stores token
  Backend profile fetched on demand
end note

Repo --> VM: Result.Success(User from Firebase)
deactivate Repo

VM -> VM: Update uiState\n(currentUser, isLoggedIn=true)

VM --> UI: Login Success
deactivate VM

UI -> UI: Navigate to EventsScreen

== Token Refresh (Automatic) ==

note over FireAuth
  Firebase SDK automatically refreshes
  tokens every 1 hour
  Interceptor always gets current token
end note

alt Token Expired or Invalid
  Backend -> Filter: Invalid token detected
  activate Filter
  Filter --> Backend: 401 Unauthorized
  deactivate Filter
  Backend --> API: 401 Response
  API --> Repo: HTTP 401
  Repo --> VM: Error
  VM -> VM: Clear auth state
  VM --> UI: Show login screen
end

@enduml
