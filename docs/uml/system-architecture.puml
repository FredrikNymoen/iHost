@startuml System Architecture
!theme plain
skinparam componentStyle rectangle

title iHost System Architecture

package "Android Frontend" {
    package "UI Layer" {
        [Jetpack Compose\nScreens] as UI
        [Navigation] as Nav
        [Components] as Comp
    }

    package "ViewModel Layer" {
        [AuthViewModel] as AuthVM
        [EventViewModel] as EventVM
        [UserViewModel] as UserVM
        [FriendViewModel] as FriendVM
        [StripeViewModel] as StripeVM
    }

    package "Data Layer" {
        package "Repositories" {
            [AuthRepository] as AuthRepo
            [EventRepository] as EventRepo
            [UserRepository] as UserRepo
            [FriendshipRepository] as FriendRepo
        }

        package "Remote API" {
            [RetrofitClient] as Retrofit
            [API Services] as API
            [FirebaseAuthInterceptor] as AuthInterceptor
        }

        package "Domain Models" {
            [User] as FrontUser
            [Event] as FrontEvent
            [EventWithMetadata] as EventMeta
            [Friendship] as FrontFriend
        }
    }
}

package "Backend (Spring Boot)" {
    package "Security Layer" {
        [SecurityConfig] as SecConfig
        [FirebaseTokenFilter] as TokenFilter
    }

    package "Controller Layer" {
        [UserController] as UserCtrl
        [EventController] as EventCtrl
        [EventUserController] as EventUserCtrl
        [FriendshipController] as FriendCtrl
        [StripeController] as StripeCtrl
        [ImageUploadController] as ImageCtrl
    }

    package "Service Layer" {
        [UserService] as UserSvc
        [EventService] as EventSvc
        [EventUserService] as EventUserSvc
        [FriendshipService] as FriendSvc
        [PaymentService] as PaymentSvc
        [ImageService] as ImageSvc
        [CloudinaryService] as CloudSvc
    }

    package "Model Layer" {
        [User Entity] as BackUser
        [Event Entity] as BackEvent
        [EventUser Entity] as EventUser
        [Friendship Entity] as BackFriend
        [DTOs] as DTOs
    }

    package "Configuration" {
        [FirebaseConfig] as FireConfig
        [CloudinaryConfig] as CloudConfig
        [StripeConfig] as StrConfig
    }
}

package "External Services" {
    cloud "Firebase" {
        [Firebase Auth] as FireAuth
        [Firestore Database] as Firestore
    }

    cloud "Stripe" {
        [Stripe API] as StripeAPI
        [Stripe Android SDK] as StripeSDK
    }

    cloud "Cloudinary" {
        [Image Storage] as Cloudinary
    }

    cloud "Google Maps" {
        [Maps SDK] as Maps
    }
}

' Frontend Internal Connections
UI --> Nav
UI --> Comp
UI --> AuthVM
UI --> EventVM
UI --> UserVM
UI --> FriendVM
UI --> StripeVM

AuthVM --> AuthRepo
EventVM --> EventRepo
UserVM --> UserRepo
FriendVM --> FriendRepo
StripeVM --> Retrofit

AuthRepo --> API
EventRepo --> API
UserRepo --> API
FriendRepo --> API

API --> Retrofit
Retrofit --> AuthInterceptor

EventRepo ..> EventMeta
UserRepo ..> FrontUser
FriendRepo ..> FrontFriend

' Frontend to External Services
UI --> Maps : Location Selection
StripeVM --> StripeSDK : Payment Processing
AuthRepo --> FireAuth : Authentication
AuthInterceptor --> FireAuth : Get ID Token

' Frontend to Backend
Retrofit --> SecConfig : HTTPS REST API\n10.0.2.2:8080
note right of Retrofit
  All requests include:
  Authorization: Bearer <firebase-token>
end note

' Backend Internal Connections
SecConfig --> TokenFilter : Filter Chain
TokenFilter --> FireAuth : Verify Token

TokenFilter --> UserCtrl : Authenticated Requests
TokenFilter --> EventCtrl
TokenFilter --> EventUserCtrl
TokenFilter --> FriendCtrl
TokenFilter --> StripeCtrl
TokenFilter --> ImageCtrl

UserCtrl --> UserSvc
EventCtrl --> EventSvc
EventUserCtrl --> EventUserSvc
FriendCtrl --> FriendSvc
StripeCtrl --> PaymentSvc
ImageCtrl --> ImageSvc
ImageSvc --> CloudSvc

UserSvc ..> BackUser
EventSvc ..> BackEvent
EventUserSvc ..> EventUser
FriendSvc ..> BackFriend

UserCtrl ..> DTOs
EventCtrl ..> DTOs
EventUserCtrl ..> DTOs
FriendCtrl ..> DTOs

' Backend to External Services
UserSvc --> Firestore : CRUD Operations
EventSvc --> Firestore
EventUserSvc --> Firestore
FriendSvc --> Firestore

FireConfig --> FireAuth : Initialize
FireConfig --> Firestore : Initialize

CloudConfig --> Cloudinary : Configure
CloudSvc --> Cloudinary : Upload/Delete

StrConfig --> StripeAPI : Configure
PaymentSvc --> StripeAPI : Payment Intents

note bottom of Firestore
  Collections:
  - users
  - events
  - event_users
  - friendships
  - event_images
end note

@enduml
